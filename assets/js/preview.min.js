var SeoSerpPreview=new Class({Implements:[Options],options:{bodySelector:".preview-body",hintSelector:".preview-hint",indexSelector:".preview-index",titleSelector:"[data-ssp-title]",urlSelector:"[data-ssp-url]",descriptionSelector:"[data-ssp-description]",keywordMarkClass:"keyword-mark",counterClass:"seo-serp-preview-counter",counterLimitClass:"limit-exceeded",noIndexClass:"no-index",titleLimit:70,descriptionLimit:156,keywordCharacterLength:4,titleFormat:"##title##"},initialize:function(c,b,a){this.el=c;this.engine=b;this.setOptions(a);this.collectElements();this.engine.addEvent("ready",function(){this.addDescriptionCounter();this.engine.addEvent("change",this.refresh.bind(this));this.refresh()}.bind(this));this.engine.init()},addDescriptionCounter:function(){this.descriptionCounter=this.engine.addDescriptionCounter(new Element("span",{"class":this.options.counterClass}))},updateDescriptionCounter:function(a){this.descriptionCounter.set("text","("+a.length+"/"+this.options.descriptionLimit+")");if(a.length>this.options.descriptionLimit){this.descriptionCounter.addClass(this.options.counterLimitClass)}else{this.descriptionCounter.removeClass(this.options.counterLimitClass)}},refresh:function(){var a=this.collectData();this.updateDescriptionCounter(a.description);if(!this.validateData(a)){this.hideBody();return}this.renderData(a);this.showBody()},collectElements:function(){this.body=this.el.getElement(this.options.bodySelector);this.hint=this.el.getElement(this.options.hintSelector);this.index=this.el.getElement(this.options.indexSelector);this.title=this.el.getElement(this.options.titleSelector);this.url=this.el.getElement(this.options.urlSelector);this.description=this.el.getElement(this.options.descriptionSelector)},collectData:function(){return data={title:this.engine.getTitle(),url:this.engine.getUrl(),description:this.engine.getDescription(),index:this.engine.getIndex?this.engine.getIndex():true}},validateData:function(c){var b=false;for(var a in c){if(c[a]!=""){b=true}}return b},renderData:function(a){this.textElements=[];this.setTitle(a.title);this.setUrl(a.url);this.setDescription(a.description);a.index?this.hideIndex():this.showIndex()},setTitle:function(a){a=this.options.titleFormat.replace("##title##",a);if(a.length>this.options.titleLimit){a=a.substr(0,this.options.titleLimit)+"..."}this.generateTextElements(a,this.title)},setUrl:function(a){this.generateTextElements(a,this.url)},setDescription:function(a){if(a.length>this.options.descriptionLimit){a=a.substr(0,this.options.descriptionLimit)+"..."}this.generateTextElements(a,this.description)},generateTextElements:function(e,c){var a=new RegExp(/\,|\.|\;|\!|\?|\-|\s|\\|\//);var d=[];c.set("html","");for(var b=0;b<e.length;b++){if(a.test(e[b])){if(d.length>0){this.createTextElement(d.join(""),c);d=[]}(new Element("span",{text:e[b]})).inject(c,"bottom");continue}d.push(e[b])}if(d.length>0){this.createTextElement(d.join(""),c)}},createTextElement:function(d,c){var a=this;var b=new Element("span",{text:d});b.addEvent("mouseenter",function(){a.markKeywords.call(a,this.get("text"),this)});b.addEvent("mouseleave",this.unmarkKeywords.bind(this));b.inject(c,"bottom");this.textElements.push(b)},markKeywords:function(g,a){var d=0;var c=[];g=g.toLowerCase();if(g.length>=this.options.keywordCharacterLength){var f=[];for(d=0;d<=(g.length-this.options.keywordCharacterLength);d++){f.push(g.substr(d,this.options.keywordCharacterLength))}for(d=0;d<this.textElements.length;d++){var e=this.textElements[d].get("text").toLowerCase();if(a&&this.textElements[d]===a){c.push(a);continue}for(var b=0;b<f.length;b++){if(e.indexOf(f[b])!==-1){c.push(this.textElements[d])}}}}else{for(d=0;d<this.textElements.length;d++){if(this.textElements[d].get("text").toLowerCase()===g){c.push(this.textElements[d])}}}if(c.length>1){for(d=0;d<c.length;d++){c[d].addClass(this.options.keywordMarkClass)}}},unmarkKeywords:function(){for(var a=0;a<this.textElements.length;a++){this.textElements[a].removeClass(this.options.keywordMarkClass)}},hideBody:function(){this.hint.show();this.body.hide()},showBody:function(){this.hint.hide();this.body.show()},hideIndex:function(){this.index.hide();this.el.removeClass(this.options.noIndexClass)},showIndex:function(){this.index.show();this.el.addClass(this.options.noIndexClass)}});