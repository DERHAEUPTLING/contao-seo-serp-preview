var SeoSerpPreview=new Class({Implements:[Options],options:{hidden:!1,bodySelector:".preview-body",hintSelector:".preview-hint",indexSelector:".preview-index",titleSelector:"[data-ssp-title]",urlSelector:"[data-ssp-url]",descriptionSelector:"[data-ssp-description]",keywordMarkClass:"keyword-mark",counterClass:"seo-serp-preview-counter",counterLimitClass:"limit-exceeded",noIndexClass:"no-index",titleLimit:70,descriptionLimit:156,keywordCharacterLength:4,titleFormat:"##title##"},initialize:function(t,e,i){this.el=t,this.engine=e,this.setOptions(i),this.collectElements(),this.engine.addEvent("ready",function(){this.addDescriptionCounter(),this.engine.addEvent("change",this.refresh.bind(this)),this.refresh()}.bind(this)),this.engine.init()},addDescriptionCounter:function(){this.descriptionCounter=this.engine.addDescriptionCounter(new Element("span",{"class":this.options.counterClass}))},updateDescriptionCounter:function(t){this.descriptionCounter.set("text","("+t.length+"/"+this.options.descriptionLimit+")"),t.length>this.options.descriptionLimit?this.descriptionCounter.addClass(this.options.counterLimitClass):this.descriptionCounter.removeClass(this.options.counterLimitClass)},refresh:function(){if(this.options.hidden&&this.engine.showElement&&!this.engine.showElement())return this.el.hide(),void this.descriptionCounter.hide();var t=this.collectData();return this.updateDescriptionCounter(t.description),this.validateData(t)?(this.renderData(t),this.showBody(),void(this.options.hidden&&(this.el.show(),this.descriptionCounter.show()))):void this.hideBody()},collectElements:function(){this.body=this.el.getElement(this.options.bodySelector),this.hint=this.el.getElement(this.options.hintSelector),this.index=this.el.getElement(this.options.indexSelector),this.title=this.el.getElement(this.options.titleSelector),this.url=this.el.getElement(this.options.urlSelector),this.description=this.el.getElement(this.options.descriptionSelector)},collectData:function(){return data={title:this.engine.getTitle(),url:this.engine.getUrl(),description:this.engine.getDescription(),index:!this.engine.getIndex||this.engine.getIndex()}},validateData:function(t){var e=!1;for(var i in t)""!=t[i]&&(e=!0);return e},renderData:function(t){this.textElements=[],this.setTitle(t.title),this.setUrl(t.url),this.setDescription(t.description),t.index?this.hideIndex():this.showIndex()},setTitle:function(t){t=this.options.titleFormat.replace("##title##",t),t.length>this.options.titleLimit&&(t=t.substr(0,this.options.titleLimit)+"..."),this.generateTextElements(t,this.title)},setUrl:function(t){this.generateTextElements(t,this.url)},setDescription:function(t){t.length>this.options.descriptionLimit&&(t=t.substr(0,this.options.descriptionLimit)+"..."),this.generateTextElements(t,this.description)},generateTextElements:function(t,e){var i=new RegExp(/\,|\.|\;|\!|\?|\-|\s|\\|\//),s=[];e.set("html","");for(var n=0;n<t.length;n++)i.test(t[n])?(s.length>0&&(this.createTextElement(s.join(""),e),s=[]),new Element("span",{text:t[n]}).inject(e,"bottom")):s.push(t[n]);s.length>0&&this.createTextElement(s.join(""),e)},createTextElement:function(t,e){var i=this,s=new Element("span",{text:t});s.addEvent("mouseenter",function(){i.markKeywords.call(i,this.get("text"),this)}),s.addEvent("mouseleave",this.unmarkKeywords.bind(this)),s.inject(e,"bottom"),this.textElements.push(s)},markKeywords:function(t,e){var i=0,s=[];if(t=t.toLowerCase(),t.length>=this.options.keywordCharacterLength){var n=[];for(i=0;i<=t.length-this.options.keywordCharacterLength;i++)n.push(t.substr(i,this.options.keywordCharacterLength));for(i=0;i<this.textElements.length;i++){var o=this.textElements[i].get("text").toLowerCase();if(e&&this.textElements[i]===e)s.push(e);else for(var h=0;h<n.length;h++)o.indexOf(n[h])!==-1&&s.push(this.textElements[i])}}else for(i=0;i<this.textElements.length;i++)this.textElements[i].get("text").toLowerCase()===t&&s.push(this.textElements[i]);if(s.length>1)for(i=0;i<s.length;i++)s[i].addClass(this.options.keywordMarkClass)},unmarkKeywords:function(){for(var t=0;t<this.textElements.length;t++)this.textElements[t].removeClass(this.options.keywordMarkClass)},hideBody:function(){this.hint.show(),this.body.hide()},showBody:function(){this.hint.hide(),this.body.show()},hideIndex:function(){this.index.hide(),this.el.removeClass(this.options.noIndexClass)},showIndex:function(){this.index.show(),this.el.addClass(this.options.noIndexClass)}});